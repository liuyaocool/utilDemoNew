号称微服务下一代 service mesh

# 网络模型

## 应用层

```
linux: 一切皆文件
cd /proc/$$/fd
    $$: 当前解释程序进程id号
    fd: 文件描述符
exec 8<> /dev/tcp/www.baidu.com/80 --建立socket连接
    <>: I/O 数入/输出
    8<>: 8指向socket(套接字通信,内核中转换为套接字)
echo -e 'get / http/1.0\n' >& 8 --http协议输送到百度
    >: 重定向输出
    &: 代表8是文件描述符,不是文件
    -e: \n 转化为换行符
    ''之间: 最简单http协议
cat 0<& 8 --读取返回结果
    标准输入0 来自文件描述符8
    cat: 读文件,从标准输入读东西
exec 8<& - --关掉
```

## 传输控制层 tcp/ip udp

- TCP/IP | UDP

- 套接字通信(socket) 65535个

- 查看建立的连接：

  ```
  netstat -natp
  ```

- 三次握手 四次分手

  ```
  TCP三次握手 通信双方都要确认是否可通信 内核层次
      客户端(SYN-SEND) 	    →(SYN) 	 	 服务端		    : 我想连接 
      客户端 			   ←(SYN-ACK) 	服务端  		   : 确认可以 
      客户端(ESABLISHED) 	→(ACK) 		 服务端(ESABLISHED): 收到确认 (数据粘连: 同时发数据) 
      								SOCKET放入accept队列
  TCP数据传输
  TCP四次分手 socket资源-可有的端口
      客户端 → 服务端: 我想断开
      客户端 ← 服务端: 确认可以
      客户端 ← 服务端: 我想断开
      客户端 → 服务端: 确认可以
  ```

## 网络层 ip

- IP 是点分字节

- 下一跳机制 网与网之间 局域网不需要

- 配置网卡: cat /etc/sysconfig/network-script/ifcfg-eth0

- 路由器： 公网IP 和 内网IP

- 路由表 路由判定 按位与

  ```
  route -n
  Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
  0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 ens33
  192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33
  说明：
  	0.0.0.0 网卡是在同一局域网中的 也就是说192.168.1网段不需要通过下一跳机制
  ```

- 应用

  1. 主机A 192.168.0.102

     ```
     route -n
     0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 ens33
     192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33
     192.168.8.0     0.0.0.0         255.255.252.0   U     0      0        0 ens33
     添加虚拟网卡：ifconfig ens33:3 192.168.11.11/24    
     	24 = 24个1 = 3个255 = 255.255.255.0
     ens33:3: ***
     	inet 192.168.11.11  netmask 255.255.255.0  broadcast 192.168.11.255
     	ether 00:0c:29:1e:57:d6  txqueuelen 1000  (Ethernet)
     ```

  2. 主机B 192.168.0.21

     ```
     route -n
     0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 ens33
     192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 ens33
     若要访问到A虚拟网卡：ping 192.168.11.11
     添加路由表：route add -host 192.168.11.11 gw 192.168.0.102
     	-host 主机
     	-net 网段
     路由表会多出
     192.168.11.11   192.168.0.102   255.255.255.255 UGH   0      0        0 ens33
     ```

## 链路层 mac

- 网卡mac地址
- arp -a   查看局域网
- dns    全网
-  不同网段之间通信
  1.  先发arp包 目标mac=全f 目标ip=192.168.1.1 交换机会广播此包
  2. 路由器会回复包 并把自己的信息发回
  3. 然后再发包

## 物理层：波分复用

## ping过程

- mac地址 点到点
- ip地址 端到端
- ping 192.168.11.11

<img src="image\ping.png" align="left">

# tomcat

- tomcat慢\并发少的原因
  1. 在七层网络协议的末端 需要经过传输控制层(三次握手)\网络层等之后才到达 再开辟资源 cpu切换状态-内核态到用户态
  2. 是java写的 运行在jvm上 jvm本身是一个应用程序 jvm里再分配虚拟机跑tomcat
     -  jvm 内核加应用程序 应用程序又虚了一个内存(等于又虚了一个虚拟机)

反向代理：代理握手

# NAT

网络地址转换  	路由器映射地址

S-NAT：源地址转换协议

D-NAT：目标地址转换协议

1. 如：192.168.1.61:234 访问 212.134.23.23:12345
2. 路由器映射：公网ip:123 → 212.134.23.23:12345
   - 123为路由器自己申请的 路由器端口

# 负载架构

client*n → LVS(数据包级别转发 负载) → nginx(负载握手) → tomcat*n

# LVS

章文嵩  开源创始人 2周写出来

linux内核 4个月

- 负载均衡服务器
- 快 - 4层
- 数据包转发级别
- 不会和client握手
- 后端服务器是镜像的

## 负载模型

- CIP clientIP
- VIP LVS对外IP
- DIP LVS分发IP
- RIP tomcatIP

### 1. D-NAT 

非对称 IP地址转换

缺点：来回都走LVS

![](image\LVS-DNAT.png)

### 2. DR

![](image\LVS-DR.png)

### 3. TUN

![](image\LVS-TUN.png)



